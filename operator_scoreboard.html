<script>
    const operatorScoreboardContainer = document.getElementById('operator-scoreboard-container');
    const operatorGlobalTimerDisplay = document.getElementById('operator-global-timer-container');

    // =====================================================================
    // –ù–ê–°–¢–†–û–ô–ö–ò PUSHER
    // =====================================================================
    const PUSHER_KEY = '5aab07a273683e30e1c4'; // <-- –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à Key
    const PUSHER_CLUSTER = 'eu';     // <-- –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à Cluster
    const PUSHER_CHANNEL_NAME = 'judge-button-system'; // –î–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å config.py
    
    // =====================================================================
    // –õ–û–ì–ò–ö–ê –ö–õ–ò–ï–ù–¢–°–ö–û–ì–û –¢–ê–ô–ú–ï–†–ê
    // =====================================================================
    let clientSideTimerId = null;
    let isTimerRunning = false;
    let timerDirection = 'COUNT_UP';
    let currentSeconds = 0;

    function tick() {
        if (timerDirection === 'COUNT_DOWN') {
            currentSeconds--;
            if (currentSeconds < 0) currentSeconds = 0;
        } else {
            currentSeconds++;
        }
        operatorGlobalTimerDisplay.textContent = formatTimeMMSS(currentSeconds);
    }

    function startClientTimer(direction, initialSeconds) {
        if (isTimerRunning) return;
        isTimerRunning = true;
        timerDirection = direction;
        currentSeconds = initialSeconds;
        operatorGlobalTimerDisplay.textContent = formatTimeMMSS(currentSeconds);
        if (clientSideTimerId) clearInterval(clientSideTimerId);
        clientSideTimerId = setInterval(tick, 1000);
    }

    function stopClientTimer() {
        if (!isTimerRunning) return;
        isTimerRunning = false;
        if (clientSideTimerId) {
            clearInterval(clientSideTimerId);
            clientSideTimerId = null;
        }
    }
    
    // =====================================================================
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PUSHER –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π
    // =====================================================================
    let allOperatorLanesData = {};

    Pusher.logToConsole = true;
    const pusher = new Pusher(PUSHER_KEY, { cluster: PUSHER_CLUSTER });
    const channel = pusher.subscribe(PUSHER_CHANNEL_NAME);

    channel.bind('lane-update', function(status) {
        if (!status || !status.lane_id) return;

        allOperatorLanesData[status.lane_id] = status;
        updateOperatorLaneDisplay(status);

        const hasActiveLane = Object.values(allOperatorLanesData).some(lane => lane.is_active);

        if (hasActiveLane) {
            if (!isTimerRunning) {
                let initialTime = (status.timer_direction === 'COUNT_DOWN') 
                    ? status.time_remaining_seconds 
                    : status.time_elapsed_seconds;
                startClientTimer(status.timer_direction, initialTime);
            }
        } else {
            if (isTimerRunning) {
                stopClientTimer();
                operatorGlobalTimerDisplay.textContent = formatTimeMMSS(status.time_elapsed_seconds);
            }
        }
    });

    pusher.connection.bind('connected', () => console.log('‚úÖ [Pusher] –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!'));
    
    // =====================================================================
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    // =====================================================================
    function formatTimeMMSS(totalSeconds) {
        if (isNaN(totalSeconds) || totalSeconds < 0) totalSeconds = 0;
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = Math.floor(totalSeconds % 60);
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') {
            if (unsafe === null || unsafe === undefined) return '';
            unsafe = unsafe.toString();
        }
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function updateOperatorLaneDisplay(status) {
        const rawLaneId = status.lane_id;
        let laneDiv = document.getElementById(`op-lane-${rawLaneId}`);
        if (!laneDiv) {
            laneDiv = document.createElement('div');
            laneDiv.className = 'op-lane';
            laneDiv.id = `op-lane-${rawLaneId}`;
            operatorScoreboardContainer.appendChild(laneDiv);
            sortOperatorLanes();
        }

        let statusText = '–û—á—ñ–∫—É–≤–∞–Ω–Ω—è', statusClass = 'status-inactive';
        if (status.is_complete) {
            statusText = "–ó–∞–≤–µ—Ä—à–µ–Ω–æ"; statusClass = 'status-complete';
        } else if (status.is_active) {
            statusText = "–ê–∫—Ç–∏–≤–Ω–∏–π"; statusClass = 'status-active';
        }
        
        const athleteName = status.athlete_name_or_lane_id;
        let displayLaneNumber = rawLaneId.split('_').pop().replace(/^0+/, '') || rawLaneId;
        
        let headerLaneText = `–î${escapeHtml(displayLaneNumber)}`;
        if (athleteName && athleteName.trim() !== '' && athleteName !== rawLaneId) {
            headerLaneText += `: ${escapeHtml(athleteName)}`;
        }

        laneDiv.innerHTML = `
            <div class="op-lane-header"><h3 class="op-lane-name">${headerLaneText}</h3></div>
            <div class="op-lane-details">
                <div class="detail-row"><span class="label">üîÑ –†–∞—É–Ω–¥:</span><span class="value">${escapeHtml(status.current_round_display)} / ${escapeHtml(status.total_rounds_display)}</span></div>
                <div class="detail-row"><span class="label">üèãÔ∏è –í–ø—Ä–∞–≤–∞:</span><span class="value">${escapeHtml(status.current_exercise_name)}</span></div>
                <div class="detail-row"><span class="label">üìä –ü—Ä–æ–≥—Ä–µ—Å:</span><span class="value">${escapeHtml(status.current_exercise_progress_display)} / ${escapeHtml(status.current_exercise_target_display)} ${escapeHtml(status.current_exercise_unit)}</span></div>
                <div class="detail-row"><span class="label">üéØ –†–∞—Ö—É–Ω–æ–∫:</span><span class="value">${escapeHtml(status.score_display_str)}</span></div>
            </div>
            <div class="op-lane-status ${statusClass}">${statusText}</div>`;
    }

    function sortOperatorLanes() {
        const lanes = Array.from(operatorScoreboardContainer.children);
        lanes.sort((a, b) => {
            const numA = parseInt(a.id.split('-').pop().split('_').pop(), 10);
            const numB = parseInt(b.id.split('-').pop().split('_').pop(), 10);
            return numA - numB;
        });
        lanes.forEach(lane => operatorScoreboardContainer.appendChild(lane));
    }
</script>